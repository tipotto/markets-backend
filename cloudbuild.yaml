steps:
  - id: 'Install dependencies, create .env file'
    name: node
    args:
      - -c
      - |
        yarn install &&
        echo PORT=8080 >> .env &&
        echo PROD_PYTHON_SCRIPT="~/api/app/python/index.py" >> .env &&
        mv node_modules .env /workspace

  - id: 'Integrate files into api directory'
    name: 'ubuntu'
    args:
      - -c
      - |
        echo "Build process started..." &&
        mkdir api &&
        mv *[^api] ./api &&
        mv /workspace/node_modules ./api
        mv /workspace/.env ./api

  - id: 'Transfer api directory with scp'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'compute',
        'scp',
        '--project',
        'markets-jp',
        '--zone',
        'asia-northeast1-b',
        '--port',
        '49152',
        '--recurse',
        './api',
        'markets-jp:~/',
      ]
    dir: 'workspace'
